---
# [1단계] 인스턴스 생성을 위한 정보 조회 및 생성 (사용자님 코드)
- name: Get Private Subnet info
  amazon.aws.ec2_vpc_subnet_info:
    region: "{{ region }}"
    filters: { "tag:Name": "{{ prefix }}-priv-a" }
  register: priv_subnet

- name: Get Jenkins SG info
  amazon.aws.ec2_security_group_info:
    region: "{{ region }}"
    filters: { "group-name": "{{ prefix }}-jenkins-sg" }
  register: jenkins_sg

- name: Find latest Ubuntu 22.04 AMI
  amazon.aws.ec2_ami_info:
    region: "{{ region }}"
    owners: ["099720109477"]
    filters:
      name: "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
      architecture: x86_64
  register: ubuntu_ami

# 4. Jenkins EC2 인스턴스 생성 (수동 조치 사항 반영)
- name: Launch Jenkins EC2 Instance with User Data
  amazon.aws.ec2_instance:
    name: "{{ prefix }}-jenkins"
    region: "{{ region }}"
    image_id: "{{ (ubuntu_ami.images | sort(attribute='creation_date') | last).image_id }}"
    instance_type: "t3.large"
    key_name: "{{ key_name }}"
    vpc_subnet_id: "{{ priv_subnet.subnets[0].id }}"
    security_groups: ["{{ jenkins_sg.security_groups[0].group_id }}"]
    iam_instance_profile: "{{ prefix }}-ec2-profile"
    wait: yes
    volumes:
      - device_name: /dev/sda1 # Ubuntu의 기본 루트 장치 이름
        ebs:
          volume_size: 30
          volume_type: gp3 
          delete_on_termination: yes
    user_data: |
      #!/bin/bash
      # 1. 패키지 업데이트 및 필수 도구 설치
      apt-get update -y
      apt-get install -y apt-transport-https ca-certificates curl software-properties-common git unzip

      # 2. Docker 및 Compose 설치
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list
      apt-get update -y
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

      # 3. AWS CLI v2 설치
      curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
      unzip -o awscliv2.zip
      ./aws/install

      # 4. 프로젝트 클론 및 수동 설정 자동 반영 (Hot-fix)
      cd /home/ubuntu
      git clone https://github.com/sjh4616/jenkins.git
      cd jenkins

      # [SSM 조치 1] Dockerfile의 apt-get update 누락 수정
      sed -i 's/RUN apt-get install zip unzip git curl/RUN apt-get update \&\& apt-get install -y zip unzip git curl/' Dockerfile

      # [SSM 조치 2] docker-compose.yml 포트 및 Prefix 수정 (Heredoc 사용)
      cat <<EOF > docker-compose.yml
      version: '3.7'
      services:
        jenkins:
          build:
            context: .
          container_name: jenkins
          user: root
          privileged: true
          ports:
            - 8080:8080
            - 50000:50000
          environment:
            - JENKINS_OPTS=--prefix=/jenkins
          volumes:
            - ./jenkins_home:/var/jenkins_home
            - /var/run/docker.sock:/var/run/docker.sock
      EOF

      # 5. 젠킨스 실행 (--build 포함하여 수정된 Dockerfile 반영)
      docker compose up -d --build

      # 6. 권한 설정
      usermod -aG docker ubuntu
      chown -R ubuntu:ubuntu /home/ubuntu/jenkins
      
    tags:
      Role: "jenkins"
      Name: "{{ prefix }}-jenkins"
  register: jenkins_ec2

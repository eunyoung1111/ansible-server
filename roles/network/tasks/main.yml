---
# 1. VPC 생성
- name: Create VPC
  amazon.aws.ec2_vpc_net:
    name: "{{ prefix }}-vpc"
    cidr_block: "{{ vpc_cidr }}"
    region: "{{ region }}"
    state: present
  register: vpc_result

# 2. 인터넷 게이트웨이 생성
- name: Create Internet Gateway
  amazon.aws.ec2_vpc_igw:
    vpc_id: "{{ vpc_result.vpc.id }}"
    region: "{{ region }}"
    state: present
    tags:
      Name: "{{ prefix }}-igw"
  register: igw_result

# 3. 서브넷 생성 (파라미터 명칭 및 변수명 교정)
- name: Create Subnets
  amazon.aws.ec2_vpc_subnet:
    vpc_id: "{{ vpc_result.vpc.id }}"
    region: "{{ region }}"
    az: "{{ item.az }}"
    cidr: "{{ item.cidr }}"
    # [수정] 2.15 버전에서는 map_public_ip_on_launch 대신 map_public을 사용합니다.
    map_public: "{{ item.public }}" 
    state: present
    tags:
      Name: "{{ prefix }}-{{ item.name }}"
  # [수정] all_vars에 정의하신 subnet_list를 사용합니다.
  loop: "{{ subnet_list }}"
  register: subnet_results
  
# 4. NAT Gateway용 탄력적 IP(EIP) 할당
- name: Allocate EIP for NAT Gateway
  amazon.aws.ec2_eip:
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-nat-eip"
    state: present
  register: nat_eip

# 5. NAT Gateway 생성 (이름 태그 및 중복 방지 로직 포함)
- name: Get NAT Gateway info
  amazon.aws.ec2_vpc_nat_gateway_info:
    region: "{{ region }}"
    filters:
      "tag:Name": "{{ prefix }}-nat-gw"
      state: ['available', 'pending']
  register: existing_nat_gw

- name: Create NAT Gateway if not exists
  amazon.aws.ec2_vpc_nat_gateway:
    region: "{{ region }}"
    subnet_id: "{{ (subnet_results.results | selectattr('item.name', 'equalto', 'pub-a') | first).subnet.id }}"
    allocation_id: "{{ nat_eip.allocation_id }}"
    wait: yes
    if_exist_do_not_create: yes
    tags:
      Name: "{{ prefix }}-nat-gw" # 요청하신 이름 태그 추가
  when: (existing_nat_gw.nat_gateways | default([])) | length == 0
  register: new_nat_gw

# 6. 라우팅 테이블 및 기타 네트워크 설정 (이후 생략 가능)
---
# roles/network/tasks/main.yml

# 1. VPC 생성
- name: Create VPC
  amazon.aws.ec2_vpc_net:
    name: "{{ prefix }}-vpc"
    cidr_block: "{{ vpc_cidr }}"
    region: "{{ region }}"
  register: vpc_result

# 2. 인터넷 게이트웨이(IGW) 생성 및 VPC 연결
- name: Create Internet Gateway
  amazon.aws.ec2_vpc_igw:
    vpc_id: "{{ vpc_result.vpc.id }}"
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-igw"
  register: igw_result

# 3. 서브넷 생성 (Loop 활용)
- name: Create Subnets
  amazon.aws.ec2_vpc_subnet:
    vpc_id: "{{ vpc_result.vpc.id }}"
    # 에러 메시지가 cidr를 요구하므로 cidr로 변경 시도
    cidr: "{{ item.cidr }}"
    az: "{{ item.az }}"
    region: "{{ region }}"
    map_public: "{{ item.public }}"
    tags:
      Name: "{{ prefix }}-{{ item.name }}"
  loop: "{{ subnets }}"
  register: subnet_results

# 4. NAT Gateway용 탄력적 IP(EIP) 생성
- name: Allocate EIP for NAT Gateway
  amazon.aws.ec2_eip:
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-nat-eip"
  register: nat_eip

# 5. NAT Gateway 생성
- name: Create NAT Gateway
  amazon.aws.ec2_vpc_nat_gateway:
    subnet_id: "{{ subnet_results.results | selectattr('item.name', 'equalto', 'pub-a') | map(attribute='subnet.id') | first }}"
    allocation_id: "{{ nat_eip.allocation_id }}"
    region: "{{ region }}"
    wait: yes
    if_exist_do_not_create: yes
  register: nat_gw_result

# 6. Public 라우팅 테이블
- name: Create Public Route Table
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_result.vpc.id }}"
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-pub-rt"
    subnets:
      - "{{ subnet_results.results | selectattr('item.name', 'equalto', 'pub-a') | map(attribute='subnet.id') | first }}"
      - "{{ subnet_results.results | selectattr('item.name', 'equalto', 'pub-c') | map(attribute='subnet.id') | first }}"
    routes:
      - dest: 0.0.0.0/0
        gateway_id: "{{ igw_result.gateway_id }}"

# 7. Private 라우팅 테이블
- name: Create Private Route Table
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_result.vpc.id }}"
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-priv-rt"
    subnets:
      - "{{ subnet_results.results | selectattr('item.name', 'equalto', 'priv-a') | map(attribute='subnet.id') | first }}"
      - "{{ subnet_results.results | selectattr('item.name', 'equalto', 'priv-c') | map(attribute='subnet.id') | first }}"
    routes:
      - dest: 0.0.0.0/0
        gateway_id: "{{ nat_gw_result.nat_gateway_id }}"

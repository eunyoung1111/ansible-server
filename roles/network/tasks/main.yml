---
# 1. VPC 생성 (DNS 호스트네임 활성화 필수)
- name: Create VPC
  amazon.aws.ec2_vpc_net:
    name: "{{ prefix }}-vpc"
    cidr_block: "{{ vpc_cidr }}"
    region: "{{ region }}"
    dns_hostnames: yes # SSM 연결을 위해 필수 설정
    dns_support: yes
    state: present
  register: vpc_result

# 2. 인터넷 게이트웨이(IGW) 생성
- name: Create Internet Gateway
  amazon.aws.ec2_vpc_igw:
    vpc_id: "{{ vpc_result.vpc.id }}"
    region: "{{ region }}"
    state: present
    tags:
      Name: "{{ prefix }}-igw"
  register: igw_result

# 3. 서브넷 생성 (all_vars의 subnet_list 기반)
- name: Create Subnets
  amazon.aws.ec2_vpc_subnet:
    vpc_id: "{{ vpc_result.vpc.id }}"
    region: "{{ region }}"
    az: "{{ item.az }}"
    cidr: "{{ item.cidr }}"
    map_public: "{{ item.public }}" # 앤서블 2.15 버전 파라미터
    state: present
    tags:
      Name: "{{ prefix }}-{{ item.name }}"
  loop: "{{ subnet_list }}"
  register: subnet_results

# 4. NAT Gateway용 탄력적 IP(EIP) 할당
- name: Allocate EIP for NAT Gateway
  amazon.aws.ec2_eip:
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-nat-eip"
    state: present
  register: nat_eip

# 5. NAT Gateway 생성 (이름 태그 및 대기 설정)
- name: Create or Update NAT Gateway
  amazon.aws.ec2_vpc_nat_gateway:
    region: "{{ region }}"
    # pub-a 서브넷에 배치 (subnet_results에서 id 추출)
    subnet_id: "{{ (subnet_results.results | selectattr('item.name', 'equalto', 'pub-a') | first).subnet.id }}"
    allocation_id: "{{ nat_eip.allocation_id }}"
    wait: yes # 생성이 완료될 때까지 대기
    if_exist_do_not_create: no # 기존에 태그 없이 생성된 경우 태그를 업데이트함
    tags:
      Name: "{{ prefix }}-nat-gw"
    state: present
  register: new_nat_gw

# 6. [조회] 리소스 정보 다시 가져오기 (변수 정의 오류 방지)
- name: Get VPC Info
  amazon.aws.ec2_vpc_net_info:
    region: "{{ region }}"
    filters: { "tag:Name": "{{ prefix }}-vpc" }
  register: vpc_info

- name: Get IGW Info
  amazon.aws.ec2_vpc_igw_info:
    region: "{{ region }}"
    filters: { "tag:Name": "{{ prefix }}-igw" }
  register: igw_info

- name: Get NAT GW Info
  amazon.aws.ec2_vpc_nat_gateway_info:
    region: "{{ region }}"
    filters: 
      "tag:Name": "{{ prefix }}-nat-gw"
      state: ['available', 'pending'] # pending 상태도 포함하여 유연하게 대응합니다.
  register: nat_info

- name: Get Subnet Info
  amazon.aws.ec2_vpc_subnet_info:
    region: "{{ region }}"
    filters: { vpc-id: "{{ vpc_info.vpcs[0].vpc_id }}" }
  register: subnet_info

# 7. 퍼블릭 라우팅 테이블 생성 및 IGW 연결 (사용자님 코드 유지)
- name: Create Public Route Table
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_info.vpcs[0].vpc_id }}"
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-pub-rt"
    subnets: "{{ subnet_info.subnets | selectattr('tags.Name', 'search', 'pub') | map(attribute='id') | list }}"
    routes:
      - dest: 0.0.0.0/0
        gateway_id: "{{ igw_info.internet_gateways[0].internet_gateway_id }}"

# 8. [최종 해결] 프라이빗 라우팅 테이블 생성 및 NAT GW 연결
- name: Create Private Route Table
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_info.vpcs[0].vpc_id }}"
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-priv-rt"
    subnets: "{{ subnet_info.subnets | selectattr('tags.Name', 'search', 'priv') | map(attribute='id') | list }}"
    routes:
      - dest: 0.0.0.0/0
        # [해결] 새로 생성된 ID가 있다면 그것을 쓰고, 없다면 조회된 리스트에서 안전하게 가져옵니다.
        nat_gateway_id: >-
          {{ 
            new_nat_gw.nat_gateway_id if (new_nat_gw.nat_gateway_id is defined) 
            else (nat_info.nat_gateways | default([{'nat_gateway_id': ''}]))[0].nat_gateway_id 
          }}
  # NAT 게이트웨이 정보가 아예 없을 경우 실행하지 않도록 방어막을 칩니다.
  when: (new_nat_gw.nat_gateway_id is defined) or (nat_info.nat_gateways | length > 0)